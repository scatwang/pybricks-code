"use strict";(self.webpackChunk_pybricks_pybricks_code=self.webpackChunk_pybricks_pybricks_code||[]).push([[5550],{55550:(e,t,o)=>{o.r(t),o.d(t,{default:()=>J});var i=o(61924),s=o(94768),n=o(41109),r=o(69642),a=o(22446),d=o(54629);const l=(0,d.P)((()=>({type:"python.message.init"}))),c=(0,d.P)((()=>({type:"python.message.didInit"}))),u=(0,d.P)((e=>({type:"python.message.didFailToInit",error:e}))),p=(0,d.P)((e=>({type:"python.message.setInterruptBuffer",buffer:e}))),y=(0,d.P)(((e,t,o)=>({type:"python.message.complete",code:e,lineNumber:t,column:o}))),g=(0,d.P)((e=>({type:"python.message.didComplete",completionListJson:e}))),h=(0,d.P)((e=>({type:"python.message.didFailToComplete",error:e}))),f=(0,d.P)(((e,t,o)=>({type:"python.message.getSignature",code:e,lineNumber:t,column:o}))),m=(0,d.P)((e=>({type:"python.message.didGetSignature",signatureHelpJson:e}))),w=(0,d.P)((e=>({type:"python.message.didFailToGetSignature",error:e}))),b=(0,d.P)(((e,t)=>({type:"python.message.writeUserFile",path:e,contents:t}))),v=(0,d.P)((e=>({type:"python.message.deleteUserFile",path:e}))),S=(0,d.P)((()=>({type:"python.message.didMountUserFileSystem"})));var q=o(38222),E=o(41397),k=o(40759),M=o(80433),C=o(13456);""===window.name&&(window.name=C.Z.createUUID());class F{constructor(e){this.history=new Array,this.storageKey=void 0,this.storageKey=`editor.activeFileHistory.${window.name}.${e}`}*getFromStorage(){try{const e=JSON.parse(sessionStorage.getItem(this.storageKey)||"[]");if(!(e instanceof Array))throw new Error("savedActiveFileHistory is not an array");for(const t of e)"string"===typeof t?yield t:console.error(`ActiveFileHistoryManager: skipping non-string item: ${t}`)}catch(e){console.error(`failed to get ${this.storageKey}: ${e}`)}}push(e){const t=this.history.indexOf(e);t>=0&&this.history.splice(t,1),this.history.push(e);try{sessionStorage.setItem(this.storageKey,JSON.stringify(this.history))}catch(o){console.error(`failed to store ${this.storageKey}: ${o}`)}}pop(e){const t=this.history.indexOf(e);if(t<0)return;const o=this.history.at(-1)===e;this.history.splice(t,1);try{sessionStorage.setItem(this.storageKey,JSON.stringify(this.history))}catch(i){console.error(`failed to store ${this.storageKey}: ${i}`)}return o?this.history.at(-1):void 0}}class z{constructor(){this.map=new Map}add(e,t,o){if(this.map.has(e))throw new Error(`bug: key '${e}' already exists in the map`);this.map.set(e,{model:t,viewState:o})}remove(e){this.map.delete(e)}has(e){return this.map.has(e)}get(e){return this.map.get(e)}updateViewState(e,t){const o=this.map.get(e);o&&(o.viewState=t)}}var x=o(38696);function*G(e,t){yield(0,i.gz)((0,k.pk)(t.id,e.getValue()))}function*$(e,t,o){for(;;){yield(0,i.qn)(t);const s=o.getValue();yield(0,i.gz)((0,a.uU)(o.uri.path,s)),yield(0,i.gw)(e)}}function A(e,t,o){e.pushUndoStop(),t.pushEditOperations([],[{range:t.getFullModelRange(),text:o.value}],void 0),e.pushUndoStop()}function*P(e,t,o){let r=!1;try{const d=[];try{const l=s.Sf.from({scheme:"pybricksCode",path:o.uuid}),c=yield(0,i.RE)((()=>(0,q.yg)(`pybricks.editor+${l}`)));if(!c)throw new M.C("FileInUse","the file is already open in another editor");d.push(c),yield(0,i.gz)((0,a.PM)(o.uuid));const{didLoad:u,didFailToLoad:p}=yield(0,i.S3)({didLoad:(0,i.qn)(a.lA.when((e=>e.uuid===o.uuid))),didFailToLoad:(0,i.qn)(a.kL.when((e=>e.uuid===o.uuid)))});if(p)throw p.error;(0,q.ri)(u);const y=s.j6.createModel(u.value,x.ad,l);d.push((()=>y.dispose()));const g=(0,n.GG)((e=>{const t=y.onDidChangeContent((t=>e(t)));return()=>t.dispose()}),n.Ef.sliding(1));d.push((()=>g.close())),yield(0,i.rM)($,1e3,g,y);const h=yield(0,i.ib)(k.QH.when((e=>e.uuid===o.uuid)),A,e,y);d.push((()=>h.cancel())),t.add(o.uuid,y,u.viewState),d.push((()=>t.remove(o.uuid))),yield(0,i.gz)((0,k.Qg)(o.uuid)),yield(0,i.qn)(k.Vs.when((e=>e.uuid===o.uuid))),r=!0,e.getModel()===y&&t.updateViewState(o.uuid,e.saveViewState()),yield(0,i.gz)((0,a.uU)(o.uuid,y.getValue()))}finally{for(const e of d.reverse())e();r&&(yield(0,i.gz)((0,k.Xm)(o.uuid)))}}catch(d){yield(0,i.gz)((0,k.Lx)(o.uuid,(0,q.bM)(d)))}}function*I(e,t,o,s){try{if(!t.has(s.uuid)){yield(0,i.gz)((0,k.cd)(s.uuid));const{didFailToOpen:e}=yield(0,i.S3)({didOpen:(0,i.qn)(k.Qg.when((e=>e.uuid===s.uuid))),didFailToOpen:(0,i.qn)(k.Lx.when((e=>e.uuid===s.uuid)))});if(e)throw e.error}const n=t.get(s.uuid);if(void 0===n)throw new Error("bug: could not get file from openFiles");const r=e.getModel();r&&t.updateViewState(r.uri.path,e.saveViewState()),e.pushUndoStop(),e.setModel(n.model),e.restoreViewState(n.viewState),e.pushUndoStop(),o.push(s.uuid),e.focus(),yield(0,i.gz)((0,k.Xl)(s.uuid))}catch(n){yield(0,i.gz)((0,k.xG)(s.uuid,(0,q.bM)(n)))}}function*L(e,t){yield(0,i.gz)((0,k.uR)(t.uuid));const{didActivate:o,didFailToActivate:s}=yield(0,i.S3)({didActivate:(0,i.qn)(k.Xl.when((e=>e.uuid===t.uuid))),didFailToActivate:(0,i.qn)(k.xG.when((e=>e.uuid===t.uuid)))});if(s)if(s.error instanceof M.C&&"FileInUse"===s.error.name){var n;const e=yield(0,i.fw)("fileStorage"),o=yield(0,i.RE)((()=>e.metadata.get(t.uuid)));yield(0,i.gz)((0,r.lm)("explorer","fileInUse",{fileName:null!==(n=null===o||void 0===o?void 0:o.path)&&void 0!==n?n:"<unknown>"}))}else yield(0,i.gz)((0,r.lm)("alerts","unexpectedError",{error:s.error}));else(0,q.ri)(o),e.revealLineInCenterIfOutsideViewport(t.line),e.setSelection({startColumn:1,startLineNumber:t.line,endColumn:1/0,endLineNumber:t.line})}function*O(e,t){const o=e.pop(t.uuid);o&&(yield(0,i.gz)((0,k.uR)(o)))}function*U(e){const t=(0,n.GG)((t=>{const o=new Array;return o.push(e.onDidChangeCursorPosition(t)),o.push(e.onDidChangeCursorSelection(t)),o.push(e.onDidScrollChange(t)),()=>o.forEach((e=>e.dispose()))}),n.Ef.sliding(1));try{for(;;){yield(0,i.qn)(t);const o=e.getModel();if(!o)continue;const s=o.uri.path;yield(0,i.gz)((0,a.U4)(s,e.saveViewState())),yield(0,i.S3)({didStore:(0,i.qn)(a.fv.when((e=>e.uuid===s))),didFailToStore:(0,i.qn)(a.eZ.when((e=>e.uuid===s)))})}}finally{t.close()}}function*V(e){(yield(0,i.Ys)((e=>e.fileStorage.isInitialized)))||(yield(0,i.qn)(a.hA));const t=new z,o=new F(e.getId());yield(0,i.ib)(k.zE,G,e),yield(0,i.ib)(k.cd,P,e,t),yield(0,i.ib)(k.uR,I,e,t,o),yield(0,i.ib)(k.iZ,L,e),yield(0,i.ib)(k.Xm,O,o),yield(0,i.rM)(U,e),yield(0,i.gz)((0,k.lx)());for(const s of o.getFromStorage())yield(0,i.gz)((0,k.uR)(s)),yield(0,i.S3)({didActivate:(0,i.qn)(k.Xl.when((e=>e.uuid===s))),didFailToActivate:(0,i.qn)(k.xG.when((e=>e.uuid===s)))})}function*_(){const e=(0,n.GG)((e=>{const t=s.j6.onDidCreateEditor(e);return()=>t.dispose()}));try{yield(0,i.ib)(e,V),yield(0,i.qn)("__never__")}finally{e.close()}}const R=1,T=2,N=3;function*H(e){(yield(0,i.Ys)((e=>e.fileStorage.isInitialized)))||(yield(0,i.qn)(a.hA));const t=yield(0,i.fw)("fileStorage"),o=(0,n.GG)((e=>(t.on("changes").subscribe(e),()=>t.on("changes").unsubscribe(e))));yield(0,i.RE)((()=>t.transaction("r",t._contents,(()=>t._contents.each((t=>e.postMessage(b(t.path,t.contents))))))));try{for(;;){const s=yield(0,i.qn)(o);for(const o of s)if(o.table===t.metadata.name)switch(o.type){case R:case T:if(o.type===T&&o.obj.sha256===o.oldObj.sha256)break;yield(0,i.RE)((()=>t.transaction("r",t._contents,(async()=>{const i=await t._contents.get(o.obj.path);i?e.postMessage(b(i.path,i.contents)):console.error(`could not find file '${o.obj.path}'`)}))));break;case N:e.postMessage(v(o.oldObj.path))}}}finally{o.close()}}function*j(){const e=new Array;try{console.debug("creating code completion worker");const t=new Worker(new URL(o.p+o.u(8760),o.b));e.push((()=>t.terminate()));const r=(0,n.GG)((e=>(t.addEventListener("message",e),()=>t.removeEventListener("message",e))),n.Ef.expanding());e.push((()=>r.close()));const a=(0,n.GG)((e=>(t.addEventListener("error",e),()=>t.removeEventListener("error",e))),n.Ef.expanding());for(e.push((()=>a.close())),t.postMessage(l()),yield(0,i.gz)((0,k.G2)());;){const{messageEvent:e,errorEvent:o}=yield(0,i.S3)({messageEvent:(0,i.qn)(r),errorEvent:(0,i.qn)(a)});if(o)throw yield(0,i.gz)((0,k.Fq)()),o.error;if((0,q.ri)(e),S.matches(e.data))yield(0,i.rM)(H,t);else{if(u.matches(e.data))throw yield(0,i.gz)((0,k.Fq)()),e.data.error;if(c.matches(e.data))break}}console.debug("code completion engine is ready"),yield(0,i.gz)((0,k.sb)());const d=new Uint8Array(new WebAssembly.Memory({initial:1,maximum:1,shared:!0}).buffer),b=()=>{d[0]=2},v=()=>{d[0]=0};crossOriginIsolated?t.postMessage(p(d)):console.warn("required headers missing for SharedArrayBuffer, cancellation will not work");const M=(0,E.l)(),C=(0,n.GG)((e=>{const t=s.Mj.registerCompletionItemProvider(x.ad,{triggerCharacters:["."],provideCompletionItems:(t,o,i,s)=>new Promise((n=>{e({model:t,position:o,context:i,token:s,resolve:n})}))});return()=>t.dispose()}),n.Ef.expanding());e.push((()=>C.close()));const F=(0,n.GG)((e=>{const t=s.Mj.registerSignatureHelpProvider(x.ad,{signatureHelpTriggerCharacters:["(",","],signatureHelpRetriggerCharacters:[")"],provideSignatureHelp:(t,o,i,s)=>new Promise((n=>{e({model:t,position:o,token:i,context:s,resolve:n})}))});return()=>t.dispose()}),n.Ef.expanding());for(e.push((()=>F.close()));;){const{complete:e,getSignature:o}=yield(0,i.S3)({complete:(0,i.qn)(C),getSignature:(0,i.qn)(F)});if(e){const o=M();console.debug(`${o}: requested completion item`);const s=e.token.onCancellationRequested((()=>{console.debug(`${o}: requested cancelation`),b()}));try{for(v(),t.postMessage(y(e.model.getValue(),e.position.lineNumber,e.position.column));;){const t=yield(0,i.qn)(r);if(h.matches(t.data)){t.data.error instanceof DOMException&&"AbortError"===t.data.error.name?console.log(`${o} canceled`):console.error(t.data.error),e.resolve(null);break}if(g.matches(t.data)){const i=JSON.parse(t.data.completionListJson);for(const[e,t]of i.entries())t.sortText=String(e).padStart(5,"0");console.debug(i),e.resolve({suggestions:i}),console.debug(`${o}: resolved: ${t.data.type}`);break}}}finally{s.dispose()}}else if(o){const e=M();console.debug(`${e}: requested signatures`);const s=o.token.onCancellationRequested((()=>{console.debug(`${e}: requested cancelation`),b()}));try{for(v(),t.postMessage(f(o.model.getValue(),o.position.lineNumber,o.position.column));;){const t=yield(0,i.qn)(r);if(w.matches(t.data)){t.data.error instanceof DOMException&&"AbortError"===t.data.error.name?console.log(`${e} canceled`):console.error(t.data.error),o.resolve(null);break}if(m.matches(t.data)){const i=JSON.parse(t.data.signatureHelpJson);console.debug(i),o.resolve({value:i,dispose:()=>{}}),console.debug(`${e}: resolved: ${t.data.type}`);break}}}finally{s.dispose()}}}}catch(t){(yield(0,i.By)())||console.error(t)}finally{e.forEach((e=>e()))}}function*J(){yield(0,i.rM)(_),yield(0,i.rM)(j)}}}]);
//# sourceMappingURL=5550.63abdfa4.chunk.js.map